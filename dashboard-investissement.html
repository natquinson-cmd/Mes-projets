<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfolio Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,sans-serif;background:#0a0515;min-height:100vh;color:#fff;overflow-x:hidden}
body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(ellipse at 20% 50%,rgba(139,92,246,.08) 0%,transparent 50%),radial-gradient(ellipse at 80% 20%,rgba(6,182,212,.06) 0%,transparent 50%),radial-gradient(ellipse at 50% 80%,rgba(236,72,153,.05) 0%,transparent 50%);pointer-events:none;z-index:0}

.mx{max-width:1280px;margin:0 auto;padding:16px;position:relative;z-index:1}
@media(min-width:768px){.mx{padding:24px}}

.card{border-radius:16px;padding:20px;background:linear-gradient(135deg,rgba(30,20,60,.92),rgba(15,10,35,.95));border:1px solid rgba(139,92,246,.12);box-shadow:0 0 20px rgba(139,92,246,.06),0 8px 32px rgba(0,0,0,.4);position:relative;overflow:hidden;transition:box-shadow .3s,border-color .3s}
.card:hover{border-color:rgba(139,92,246,.25);box-shadow:0 0 30px rgba(139,92,246,.12),0 8px 40px rgba(0,0,0,.5)}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(139,92,246,.3),transparent);animation:shimmer 3s ease-in-out infinite}

@keyframes shimmer{0%,100%{opacity:.3}50%{opacity:.8}}
@keyframes pulse-glow{0%,100%{box-shadow:0 0 15px rgba(139,92,246,.1),0 8px 32px rgba(0,0,0,.3)}50%{box-shadow:0 0 30px rgba(139,92,246,.25),0 8px 32px rgba(0,0,0,.3)}}
@keyframes glow-border{0%,100%{border-color:rgba(139,92,246,.15)}50%{border-color:rgba(139,92,246,.35)}}
@keyframes float-in{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes neon-pulse{0%,100%{filter:drop-shadow(0 0 4px currentColor)}50%{filter:drop-shadow(0 0 10px currentColor)}}

.stat-card{animation:pulse-glow 4s ease-in-out infinite,float-in .5s ease}
.stat-card:nth-child(2){animation-delay:.1s,.1s}
.stat-card:nth-child(3){animation-delay:.6s,.2s}
.stat-card:nth-child(4){animation-delay:1.1s,.3s}
.stat-card:nth-child(5){animation-delay:1.6s,.4s}

.chart-card{animation:glow-border 5s ease-in-out infinite,float-in .6s ease}
.chart-card::after{content:'';position:absolute;bottom:0;left:10%;right:10%;height:1px;background:linear-gradient(90deg,transparent,rgba(139,92,246,.2),transparent)}

.kpi-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;position:relative}
.kpi-icon::after{content:'';position:absolute;inset:-3px;border-radius:12px;background:inherit;opacity:.35;filter:blur(10px);z-index:-1}

.neon-bar{height:6px;border-radius:99px;overflow:hidden;background:rgba(255,255,255,.03);position:relative}
.neon-fill{height:100%;border-radius:99px;position:relative;transition:width .6s ease}
.neon-fill::after{content:'';position:absolute;top:-3px;right:0;width:10px;height:12px;border-radius:50%;background:inherit;filter:blur(5px);opacity:.9}

.btn{padding:8px 16px;border-radius:10px;font-size:12px;font-weight:500;border:none;cursor:pointer;transition:all .25s;color:#fff;position:relative;overflow:hidden}
.btn:hover{transform:translateY(-1px)}
.btn-p{background:linear-gradient(135deg,#8b5cf6,#6d28d9);box-shadow:0 0 12px rgba(139,92,246,.2)}
.btn-p:hover{box-shadow:0 0 20px rgba(139,92,246,.4)}
.btn-s{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1)}
.btn-ok{background:linear-gradient(135deg,#10b981,#059669);box-shadow:0 0 12px rgba(16,185,129,.15)}
.btn-ok:hover{box-shadow:0 0 20px rgba(16,185,129,.3)}
.btn-d{background:linear-gradient(135deg,#ef4444,#dc2626)}

input[type=number],select{width:100%;border-radius:8px;padding:8px 12px;font-size:12px;color:#fff;outline:none;font-family:inherit;transition:border-color .2s,box-shadow .2s}
input[type=number]{background:rgba(139,92,246,.06);border:1px solid rgba(139,92,246,.15)}
input[type=number]:focus{border-color:rgba(139,92,246,.4);box-shadow:0 0 12px rgba(139,92,246,.15)}
input.loan-input{background:rgba(239,68,68,.04);border:1px solid rgba(239,68,68,.12)}
input.loan-input:focus{border-color:rgba(239,68,68,.3);box-shadow:0 0 12px rgba(239,68,68,.1)}
select{background:rgba(139,92,246,.12);border:1px solid rgba(139,92,246,.25);cursor:pointer}
select option{background:#1a103a}

.tabs{display:flex;gap:4px;padding:4px;border-radius:12px;background:rgba(139,92,246,.06);border:1px solid rgba(139,92,246,.1);flex-wrap:wrap}
.tab{padding:8px 12px;border-radius:8px;font-size:12px;font-weight:500;border:none;cursor:pointer;transition:all .3s;color:rgba(255,255,255,.5);background:transparent}
.tab:hover{color:rgba(255,255,255,.7)}
.tab.active{background:linear-gradient(135deg,#8b5cf6,#6d28d9);color:#fff;box-shadow:0 0 16px rgba(139,92,246,.3)}

table{width:100%;font-size:12px;border-collapse:collapse}
th{text-align:left;padding:8px 4px;font-weight:500;color:rgba(255,255,255,.5)}
td{padding:10px 4px}
.th-r,.td-r{text-align:right}

.dot{width:8px;height:8px;border-radius:50%;display:inline-block;flex-shrink:0}
.dot-glow{box-shadow:0 0 6px currentColor}
.dot-s{width:12px;height:12px;border-radius:50%;display:inline-block;flex-shrink:0}
.grid{display:grid;gap:16px}
.grid-2{grid-template-columns:1fr 1fr}
.grid-kpi{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
@media(max-width:900px){.grid-kpi{grid-template-columns:repeat(3,1fr)}}
@media(max-width:600px){.grid-kpi{grid-template-columns:repeat(2,1fr)}}
.grid-form{grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
.flex{display:flex}.gap2{gap:8px}.gap3{gap:12px}.gap4{gap:16px}.aic{align-items:center}.jcsb{justify-content:space-between}.fw{flex-wrap:wrap}.fcol{flex-direction:column}
.mt2{margin-top:8px}.mt4{margin-top:16px}.mb3{margin-bottom:12px}.mb4{margin-bottom:16px}.mb6{margin-bottom:24px}
.t-xs{font-size:12px}.t-sm{font-size:14px}.t-lg{font-size:18px}.t-xl{font-size:20px}.t-2xl{font-size:24px}
.fw5{font-weight:500}.fw6{font-weight:600}.fw7{font-weight:700}
.c50{color:rgba(255,255,255,.5)}.c40{color:rgba(255,255,255,.4)}.c30{color:rgba(255,255,255,.3)}.c70{color:rgba(255,255,255,.7)}
.cg{color:#10b981}.cr{color:#ef4444}.cy{color:#f59e0b}
.trunc{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ox{overflow-x:auto}
.hidden{display:none}
.form-card{border-radius:12px;padding:16px;background:rgba(255,255,255,.02);border:1px solid rgba(139,92,246,.08);transition:border-color .2s}
.form-card:hover{border-color:rgba(139,92,246,.2)}
.loan-card{border-radius:12px;padding:16px;background:rgba(239,68,68,.02);border:1px solid rgba(239,68,68,.08);transition:border-color .2s}
.loan-card:hover{border-color:rgba(239,68,68,.15)}
.ind-card{border-radius:12px;padding:12px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.04)}
.info-box{border-radius:12px;padding:16px;background:rgba(139,92,246,.06);border:1px solid rgba(139,92,246,.15)}
.notif{position:fixed;top:16px;right:16px;z-index:50;border-radius:12px;padding:12px 20px;font-size:12px;font-weight:500;color:#fff;animation:float-in .3s ease;transition:opacity .3s}
.save-ind{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:6px;font-size:11px;color:#10b981;background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.1)}
.canvas-wrap{position:relative;width:100%;height:300px}
.canvas-wrap canvas{width:100%!important;height:100%!important}
@media(max-width:767px){.grid-2{grid-template-columns:1fr}.mob-col{flex-direction:column}}
</style>
</head>
<body>
<div class="mx" id="app"></div>

<script>
// ========== DATA ==========
var COLORS = ["#8b5cf6","#06b6d4","#f59e0b","#ec4899","#10b981","#3b82f6","#f97316","#a855f7","#14b8a6","#f43f5e"];
var LC = ["#ef4444","#f97316","#eab308"];
var MN = ["Jan","F√©v","Mar","Avr","Mai","Jun","Jul","Ao√ª","Sep","Oct","Nov","D√©c"];
var SK = "portfolio_dashboard_v3";
var charts = {};

var DEFAULT_DATA = {
  platforms:["RMM","Lendermarket","Revolut","Mintos","Robot Trading","RealT","Debitum"],
  months:["2023-11","2023-12","2024-01","2024-02","2024-03","2024-04","2024-05","2024-06","2024-07","2024-08","2024-09","2024-10","2024-11","2024-12","2025-01","2025-02","2025-03","2025-04","2025-05","2025-06","2025-07","2025-08","2025-09","2025-10","2025-11","2025-12"],
  interests:{"RMM":[24,218,186,96,80,20,8,29,0,0,0,0,0,0,30,30,30,30,30,100,100,100,100,10,10,8],"Lendermarket":[42,148,124,276,176,110,217,138,188,148,105,167,134,140,155,0,0,30,120,172,174,211,220,287,272,282],"Revolut":[3,27,33,64,57,51,51,0,0,0,0,0,0,15,92,92,90,50,32,34,26,25,25,25,25,10],"Mintos":[35,131,165,159,147,150,166,153,181,147,152,157,199,190,200,131,121,105,22,23,10,3,0,0,0,0],"Robot Trading":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"RealT":[245,252,253,253,255,240,240,240,240,240,240,240,250,250,250,250,220,220,220,220,220,220,30,30,30,30],"Debitum":[4,92,154,238,305,338,413,401,422,415,413,464,509,674,675,602,512,539,611,694,730,663,729,729,663,691]},
  principal:{"RMM":[25000,10000,5699,5567,2598,0,1000,1603,1620,1693,207,2191,2382,2382,15000,15000,14200,14200,14200,14200,14200,14200,10000,1055,1055,1055],"Lendermarket":[14000,14000,12094,12221,12397,12275,12084,11754,9126,9274,9379,9546,10210,10210,12332,0,0,11700,12000,12543,12671,12906,12906,19426,19685,21780],"Revolut":[2000,4000,5815,5858,5915,0,0,0,2700,3269,3269,0,3269,3269,39984,39984,36000,26500,27838,21000,19500,20700,13000,6000,5000,700],"Mintos":[13000,12500,12087,12170,12332,13426,13709,13864,14031,14963,15417,18796,19047,19047,9769,9769,10015,3130,1332,894,904,247,247,206,206,206],"Robot Trading":[0,0,0,0,0,0,0,8284,7650,6007,6453,6453,0,0,0,0,5000,0,0,0,0,0,700,2000,0,5000],"RealT":[31500,31500,29123,29123,29395,29800,29500,30147,29377,29500,29700,29700,29950,29950,29950,29950,29500,28000,28000,28000,28000,28000,32000,32000,32000,32000],"Debitum":[0,15000,22986,23334,27372,34681,34915,34930,32913,32809,32910,43558,48513,49000,52994,52994,40642,51155,53701,60518,61336,61336,61339,60341,60341,54561]},
  loanNames:["Emprunt Younited","Emprunt Revolut","Emprunt RMM"],
  loanMonthlyPayments:{"Emprunt Younited":747,"Emprunt Revolut":0,"Emprunt RMM":0},
  loans:{"Emprunt Younited":[38300,38300,38300,38300,38300,38300,38300,38300,38300,38300,38300,38300,38300,38300,38300,38300,38300,38300,38300,38300,38300,38300,38300,38300,38300,38300],"Emprunt Revolut":[17700,17700,17700,17700,17700,17700,17700,17700,17700,17700,17700,17700,17700,17700,17700,17700,17700,17700,17700,17700,17700,17700,17700,17700,17700,17700],"Emprunt RMM":[5200,5200,5200,5200,5200,5200,5200,5200,5200,5200,5200,5200,5200,5200,5200,5200,5200,5200,5200,5200,5200,5200,5200,5200,5200,5200]}
};

// ========== HELPERS ==========
function loadData(){try{var s=localStorage.getItem(SK);if(s){var d=JSON.parse(s);if(d&&d.platforms&&d.months)return d;}}catch(e){}return JSON.parse(JSON.stringify(DEFAULT_DATA));}
function saveData(d){try{localStorage.setItem(SK,JSON.stringify(d));}catch(e){}}
function fmMonth(ym){var p=ym.split("-");return MN[parseInt(p[1],10)-1]+" "+p[0];}
function fmShort(ym){var p=ym.split("-");return MN[parseInt(p[1],10)-1]+" '"+p[0].slice(2);}
function nextMonth(ym){var p=ym.split("-"),y=+p[0],m=+p[1];if(m===12){y++;m=1;}else{m++;}return y+"-"+(m<10?"0":"")+m;}
function fmt(v){return v.toLocaleString('fr-FR')+' ‚Ç¨';}
function fmtK(v){return v>=1000?(v/1000).toFixed(0)+'k‚Ç¨':v+'‚Ç¨';}
function hexToRgba(hex,a){var r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return'rgba('+r+','+g+','+b+','+a+')';}
function destroyCharts(){for(var k in charts){if(charts[k]){charts[k].destroy();delete charts[k];}}}

var data = loadData();
var currentTab = "overview";
var editMonth = data.months.length - 1;
var editing = false;
var formData = {};
var loanFormData = {};
var showAddMonth = false;

// ========== CHART.JS DEFAULTS ==========
Chart.defaults.color = 'rgba(255,255,255,.4)';
Chart.defaults.borderColor = 'rgba(255,255,255,.04)';
Chart.defaults.font.family = 'Inter';
Chart.defaults.font.size = 11;
Chart.defaults.plugins.legend.labels.boxWidth = 10;
Chart.defaults.plugins.legend.labels.padding = 12;
Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(10,5,21,.95)';
Chart.defaults.plugins.tooltip.borderColor = 'rgba(139,92,246,.3)';
Chart.defaults.plugins.tooltip.borderWidth = 1;
Chart.defaults.plugins.tooltip.cornerRadius = 12;
Chart.defaults.plugins.tooltip.padding = 12;
Chart.defaults.plugins.tooltip.titleFont = {weight:'600'};
Chart.defaults.plugins.tooltip.callbacks.label = function(ctx){return ' '+ctx.dataset.label+': '+fmt(ctx.parsed.y||ctx.parsed||0);};
Chart.defaults.elements.point.radius = 0;
Chart.defaults.elements.point.hoverRadius = 4;
Chart.defaults.animation.duration = 800;

// ========== COMPUTE ==========
function compute(){
  var li = data.months.length - 1;
  var tp = data.platforms.reduce(function(s,p){return s+(data.principal[p]?data.principal[p][li]||0:0);},0);
  var tl = (data.loanNames||[]).reduce(function(s,l){return s+((data.loans[l]||[])[li]||0);},0);
  var nc = tp - tl;
  var tic = data.platforms.reduce(function(s,p){return s+((data.interests[p]||[]).reduce(function(a,b){return a+b;},0));},0);
  var lmi = data.platforms.reduce(function(s,p){return s+((data.interests[p]||[])[li]||0);},0);
  var pmi = li>0?data.platforms.reduce(function(s,p){return s+((data.interests[p]||[])[li-1]||0);},0):0;
  var mc = pmi>0?((lmi-pmi)/pmi*100).toFixed(1):0;
  var am = data.months.length>0?Math.round(tic/data.months.length):0;
  var tmp = (data.loanNames||[]).reduce(function(s,l){return s+((data.loanMonthlyPayments||{})[l]||0);},0);
  return{tp:tp,tl:tl,nc:nc,tic:tic,lmi:lmi,mc:mc,am:am,tmp:tmp,nmi:lmi-tmp,li:li};
}

// ========== LABELS ==========
function getLabels(){return data.months.map(fmShort);}

// ========== NOTIFY ==========
function notify(msg,type){
  var el=document.createElement('div');
  el.className='notif';
  el.style.background=type==='err'?'linear-gradient(135deg,#ef4444,#dc2626)':'linear-gradient(135deg,#10b981,#059669)';
  el.style.boxShadow='0 0 20px '+(type==='err'?'rgba(239,68,68,.3)':'rgba(16,185,129,.3)');
  el.textContent=msg;
  document.body.appendChild(el);
  setTimeout(function(){el.style.opacity='0';setTimeout(function(){el.remove();},300);},2500);
}

// ========== RENDER ==========
function render(){
  destroyCharts();
  var t=compute();
  var li=t.li;
  var labels=getLabels();
  var app=document.getElementById('app');
  var h='';

  // HEADER
  h+='<div class="flex jcsb aic fw mb6 gap4 mob-col">';
  h+='<div><h1 class="t-2xl fw7" style="letter-spacing:-0.5px">Portfolio Dashboard</h1>';
  h+='<p class="t-xs c40" style="margin-top:4px">Suivi de vos investissements P2P & Crypto</p></div>';
  h+='<div class="flex aic gap3 fw">';
  h+='<div class="save-ind"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>Auto-save</div>';
  h+='<div class="tabs">';
  [{id:"overview",l:"Vue d'ensemble"},{id:"interests",l:"Int√©r√™ts"},{id:"evolution",l:"√âvolution"},{id:"loans",l:"Emprunts"},{id:"update",l:"Mise √† jour"}].forEach(function(tb){
    h+='<button class="tab'+(currentTab===tb.id?' active':'')+'" onclick="switchTab(\''+tb.id+'\')">'+tb.l+'</button>';
  });
  h+='</div></div></div>';

  // KPIs
  h+='<div class="grid-kpi mb6">';
  [{l:"Capital Brut",v:fmt(t.tp),i:"üí∞",c:"#8b5cf6",s:data.platforms.filter(function(p){return(data.principal[p]||[])[li]>0;}).length+" plateformes"},
   {l:"Capital Net",v:fmt(t.nc),i:"üè¶",c:t.nc>=0?"#10b981":"#ef4444",s:"Emprunts : "+fmt(t.tl)},
   {l:"Int√©r√™ts du mois",v:fmt(t.lmi),i:"üìà",c:"#06b6d4",s:(t.mc>0?"+":"")+t.mc+"% vs pr√©c."},
   {l:"Int√©r√™ts cumul√©s",v:fmt(t.tic),i:"üìä",c:"#f59e0b",s:"Moy. "+fmt(t.am)+"/mois"},
   {l:"Revenu net/mois",v:fmt(t.nmi),i:"‚ö°",c:t.nmi>=0?"#10b981":"#ef4444",s:"Remb. "+fmt(t.tmp)+"/mois"}
  ].forEach(function(k,i){
    h+='<div class="card stat-card" style="animation-delay:'+(.5*i)+'s,'+(.1*i)+'s">';
    h+='<div class="flex aic gap2"><div class="kpi-icon" style="background:'+k.c+'18;color:'+k.c+'">'+k.i+'</div><span class="t-xs fw5 c50">'+k.l+'</span></div>';
    h+='<div class="t-xl fw7 trunc" style="margin-top:6px">'+k.v+'</div>';
    h+='<div class="t-xs c40" style="margin-top:2px">'+k.s+'</div>';
    h+='</div>';
  });
  h+='</div>';

  // TAB CONTENT
  if(currentTab==='overview') h+=renderOverview(t,labels,li);
  else if(currentTab==='interests') h+=renderInterests(t,labels);
  else if(currentTab==='evolution') h+=renderEvolution(t,labels,li);
  else if(currentTab==='loans') h+=renderLoans(t,labels,li);
  else if(currentTab==='update') h+=renderUpdate(t,li);

  // FOOTER
  h+='<div class="t-xs c30" style="text-align:center;margin-top:32px;opacity:.4">Portfolio Dashboard ‚Äî '+data.months.length+' mois ‚Äî Dernier : '+(data.months.length>0?fmMonth(data.months[data.months.length-1]):'')+'</div>';

  app.innerHTML=h;

  // BUILD CHARTS after DOM is ready
  requestAnimationFrame(function(){
    if(currentTab==='overview') buildOverviewCharts(t,labels,li);
    else if(currentTab==='interests') buildInterestCharts(t,labels);
    else if(currentTab==='evolution') buildEvolutionCharts(t,labels,li);
    else if(currentTab==='loans') buildLoanCharts(t,labels,li);
  });
}

// ========== OVERVIEW TAB ==========
function renderOverview(t,labels,li){
  var h='<div class="grid">';
  h+='<div class="grid grid-2">';
  // Capital chart
  h+='<div class="card chart-card"><h3 class="t-sm fw6 mb4">√âvolution capital brut vs net</h3><div class="canvas-wrap"><canvas id="ch-capital"></canvas></div></div>';
  // Pie
  h+='<div class="card chart-card"><h3 class="t-sm fw6 mb4">R√©partition actuelle</h3><div class="canvas-wrap"><canvas id="ch-pie"></canvas></div></div>';
  h+='</div>';
  h+='<div class="grid grid-2">';
  // Stacked bar
  h+='<div class="card chart-card"><h3 class="t-sm fw6 mb4">Int√©r√™ts mensuels</h3><div class="canvas-wrap"><canvas id="ch-intbar"></canvas></div></div>';
  // Platform detail
  h+='<div class="card"><h3 class="t-sm fw6 mb4">D√©tails par plateforme</h3><div style="display:flex;flex-direction:column;gap:12px">';
  data.platforms.forEach(function(p,i){
    var v=(data.principal[p]||[])[li]||0;
    var pc=t.tp>0?(v/t.tp*100).toFixed(1):0;
    var iv=(data.interests[p]||[])[li]||0;
    if(v>0){
      h+='<div><div class="flex jcsb t-xs" style="margin-bottom:4px"><span class="flex aic gap2"><span class="dot" style="background:'+COLORS[i%10]+';box-shadow:0 0 6px '+COLORS[i%10]+'"></span><span class="c70">'+p+'</span></span><span class="fw5">'+fmt(v)+'</span></div>';
      h+='<div class="neon-bar"><div class="neon-fill" style="width:'+pc+'%;background:'+COLORS[i%10]+'"></div></div>';
      h+='<div class="flex jcsb t-xs c30" style="margin-top:2px"><span>'+pc+'%</span><span>+'+fmt(iv)+' ce mois</span></div></div>';
    }
  });
  h+='</div></div>';
  h+='</div></div>';
  return h;
}

function buildOverviewCharts(t,labels,li){
  // Capital brut vs net
  var brutData=data.months.map(function(_,i){return data.platforms.reduce(function(s,p){return s+((data.principal[p]||[])[i]||0);},0);});
  var empData=data.months.map(function(_,i){return(data.loanNames||[]).reduce(function(s,l){return s+((data.loans[l]||[])[i]||0);},0);});
  var netData=brutData.map(function(b,i){return b-empData[i];});

  charts.capital=new Chart(document.getElementById('ch-capital'),{type:'line',data:{labels:labels,datasets:[
    {label:'Capital brut',data:brutData,borderColor:'#8b5cf6',backgroundColor:hexToRgba('#8b5cf6',.08),fill:true,borderWidth:2,tension:.3},
    {label:'Emprunts',data:empData,borderColor:'#ef4444',borderDash:[5,5],backgroundColor:'transparent',fill:false,borderWidth:1.5,tension:.3},
    {label:'Capital net',data:netData,borderColor:'#10b981',backgroundColor:hexToRgba('#10b981',.08),fill:true,borderWidth:2,tension:.3}
  ]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{ticks:{maxTicksLimit:8}},y:{ticks:{callback:fmtK}}},plugins:{tooltip:{callbacks:{label:function(ctx){return ' '+ctx.dataset.label+': '+fmt(ctx.parsed.y);}}}}}});

  // Pie
  var pieData=data.platforms.map(function(p,i){return{name:p,value:(data.principal[p]||[])[li]||0,color:COLORS[i%10]};}).filter(function(d){return d.value>0;});
  charts.pie=new Chart(document.getElementById('ch-pie'),{type:'doughnut',data:{labels:pieData.map(function(d){return d.name;}),datasets:[{data:pieData.map(function(d){return d.value;}),backgroundColor:pieData.map(function(d){return d.color;}),borderWidth:0,hoverOffset:8}]},options:{responsive:true,maintainAspectRatio:false,cutout:'55%',plugins:{legend:{position:'bottom',labels:{padding:8,font:{size:10}}},tooltip:{callbacks:{label:function(ctx){var total=ctx.dataset.data.reduce(function(a,b){return a+b;},0);return ' '+ctx.label+': '+fmt(ctx.parsed)+' ('+Math.round(ctx.parsed/total*100)+'%)';}}}}},});

  // Stacked bar
  var datasets=data.platforms.filter(function(p){return(data.interests[p]||[]).some(function(v){return v>0;});}).map(function(p,i){return{label:p,data:data.months.map(function(_,j){return(data.interests[p]||[])[j]||0;}),backgroundColor:hexToRgba(COLORS[data.platforms.indexOf(p)%10],.75),borderRadius:2};});
  charts.intbar=new Chart(document.getElementById('ch-intbar'),{type:'bar',data:{labels:labels,datasets:datasets},options:{responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true,ticks:{maxTicksLimit:8}},y:{stacked:true}},plugins:{tooltip:{mode:'index',callbacks:{label:function(ctx){return ' '+ctx.dataset.label+': '+fmt(ctx.parsed.y);},footer:function(items){return 'Total: '+fmt(items.reduce(function(s,i){return s+i.parsed.y;},0));}}}}}});
}

// ========== INTERESTS TAB ==========
function renderInterests(t,labels){
  var h='<div class="grid">';
  h+='<div class="card chart-card"><h3 class="t-sm fw6 mb4">Int√©r√™ts cumul√©s par plateforme</h3><div class="canvas-wrap" style="height:350px"><canvas id="ch-cumul"></canvas></div></div>';
  h+='<div class="grid grid-2">';
  h+='<div class="card chart-card"><h3 class="t-sm fw6 mb4">R√©partition des int√©r√™ts</h3><div class="canvas-wrap" style="height:280px"><canvas id="ch-intpie"></canvas></div></div>';
  h+='<div class="card"><h3 class="t-sm fw6 mb4">Classement par plateforme</h3><div style="display:flex;flex-direction:column;gap:12px">';
  var sorted=data.platforms.map(function(p,i){return{name:p,total:(data.interests[p]||[]).reduce(function(a,b){return a+b;},0),color:COLORS[i%10]};}).filter(function(d){return d.total>0;}).sort(function(a,b){return b.total-a.total;});
  var mx=sorted.length>0?sorted[0].total:1;
  sorted.forEach(function(d){
    h+='<div><div class="flex jcsb t-xs" style="margin-bottom:4px"><span class="flex aic gap2"><span class="dot" style="background:'+d.color+';box-shadow:0 0 6px '+d.color+'"></span><span class="c70">'+d.name+'</span></span><span class="fw5">'+fmt(d.total)+'</span></div>';
    h+='<div class="neon-bar"><div class="neon-fill" style="width:'+(d.total/mx*100)+'%;background:'+d.color+'"></div></div></div>';
  });
  h+='</div></div></div>';
  h+='<div class="card chart-card"><h3 class="t-sm fw6 mb4">√âvolution mensuelle des int√©r√™ts</h3><div class="canvas-wrap"><canvas id="ch-intline"></canvas></div></div>';
  h+='</div>';
  return h;
}

function buildInterestCharts(t,labels){
  // Cumulative
  var cumSets=data.platforms.filter(function(p){return(data.interests[p]||[]).some(function(v){return v>0;});}).map(function(p){
    var cum=[];var total=0;var idx=data.platforms.indexOf(p);
    data.months.forEach(function(_,i){total+=(data.interests[p]||[])[i]||0;cum.push(total);});
    return{label:p,data:cum,borderColor:COLORS[idx%10],backgroundColor:hexToRgba(COLORS[idx%10],.06),fill:true,borderWidth:1.5,tension:.3};
  });
  charts.cumul=new Chart(document.getElementById('ch-cumul'),{type:'line',data:{labels:labels,datasets:cumSets},options:{responsive:true,maintainAspectRatio:false,scales:{x:{ticks:{maxTicksLimit:8}},y:{ticks:{callback:fmtK}}}}});

  // Pie
  var ipd=data.platforms.map(function(p,i){return{name:p,value:(data.interests[p]||[]).reduce(function(a,b){return a+b;},0),color:COLORS[i%10]};}).filter(function(d){return d.value>0;});
  charts.intpie=new Chart(document.getElementById('ch-intpie'),{type:'doughnut',data:{labels:ipd.map(function(d){return d.name;}),datasets:[{data:ipd.map(function(d){return d.value;}),backgroundColor:ipd.map(function(d){return d.color;}),borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,cutout:'55%',plugins:{legend:{position:'bottom',labels:{padding:8,font:{size:10}}}}}});

  // Line
  var lineSets=data.platforms.filter(function(p){return(data.interests[p]||[]).some(function(v){return v>0;});}).map(function(p){
    var idx=data.platforms.indexOf(p);
    return{label:p,data:data.months.map(function(_,i){return(data.interests[p]||[])[i]||0;}),borderColor:COLORS[idx%10],backgroundColor:'transparent',borderWidth:1.5,tension:.3};
  });
  charts.intline=new Chart(document.getElementById('ch-intline'),{type:'line',data:{labels:labels,datasets:lineSets},options:{responsive:true,maintainAspectRatio:false,scales:{x:{ticks:{maxTicksLimit:8}}}}});
}

// ========== EVOLUTION TAB ==========
function renderEvolution(t,labels,li){
  var h='<div class="grid">';
  h+='<div class="card chart-card"><h3 class="t-sm fw6 mb4">Capital par plateforme (empil√©)</h3><div class="canvas-wrap" style="height:380px"><canvas id="ch-stack"></canvas></div></div>';
  h+='<div class="grid grid-2">';
  h+='<div class="card chart-card"><h3 class="t-sm fw6 mb4">Variation mensuelle du capital</h3><div class="canvas-wrap"><canvas id="ch-var"></canvas></div></div>';
  h+='<div class="card chart-card"><h3 class="t-sm fw6 mb4">Mois actuel vs pr√©c√©dent</h3><div class="canvas-wrap"><canvas id="ch-compare"></canvas></div></div>';
  h+='</div></div>';
  return h;
}

function buildEvolutionCharts(t,labels,li){
  // Stacked area
  var stackSets=data.platforms.filter(function(p){return(data.principal[p]||[]).some(function(v){return v>0;});}).map(function(p){
    var idx=data.platforms.indexOf(p);
    return{label:p,data:data.months.map(function(_,i){return(data.principal[p]||[])[i]||0;}),borderColor:COLORS[idx%10],backgroundColor:hexToRgba(COLORS[idx%10],.15),fill:true,borderWidth:1.5,tension:.3};
  });
  charts.stack=new Chart(document.getElementById('ch-stack'),{type:'line',data:{labels:labels,datasets:stackSets},options:{responsive:true,maintainAspectRatio:false,scales:{x:{ticks:{maxTicksLimit:10}},y:{stacked:true,ticks:{callback:fmtK}}},plugins:{tooltip:{mode:'index'}}}});

  // Variation bar
  var totals=data.months.map(function(_,i){return data.platforms.reduce(function(s,p){return s+((data.principal[p]||[])[i]||0);},0);});
  var variations=totals.slice(1).map(function(v,i){return v-totals[i];});
  charts.varChart=new Chart(document.getElementById('ch-var'),{type:'bar',data:{labels:labels.slice(1),datasets:[{label:'Variation',data:variations,backgroundColor:variations.map(function(v){return v>=0?hexToRgba('#10b981',.7):hexToRgba('#ef4444',.7);}),borderRadius:3}]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{ticks:{maxTicksLimit:8}},y:{ticks:{callback:fmtK}}},plugins:{legend:{display:false}}}});

  // Compare bar
  var compData=data.platforms.filter(function(p){return((data.principal[p]||[])[li]||0)>0||((data.principal[p]||[])[Math.max(0,li-1)]||0)>0;});
  charts.compare=new Chart(document.getElementById('ch-compare'),{type:'bar',data:{labels:compData.map(function(p){return p;}),datasets:[
    {label:'Pr√©c√©dent',data:compData.map(function(p){return(data.principal[p]||[])[Math.max(0,li-1)]||0;}),backgroundColor:hexToRgba('#8b5cf6',.25),borderRadius:3},
    {label:'Actuel',data:compData.map(function(p){return(data.principal[p]||[])[li]||0;}),backgroundColor:hexToRgba('#8b5cf6',.75),borderRadius:3}
  ]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',scales:{x:{ticks:{callback:fmtK}}}}});
}

// ========== LOANS TAB ==========
function renderLoans(t,labels,li){
  var h='<div class="grid">';
  // Loan cards
  h+='<div class="grid-kpi">';
  (data.loanNames||[]).forEach(function(l,i){
    var cu=(data.loans[l]||[])[li]||0;
    var ini=(data.loans[l]||[])[0]||cu;
    var po=ini-cu;
    var pp=ini>0?(po/ini*100).toFixed(1):0;
    var mo=(data.loanMonthlyPayments||{})[l]||0;
    h+='<div class="card" style="border-color:rgba(239,68,68,.1)">';
    h+='<div class="flex aic gap2 mb3"><span class="dot-s" style="background:'+LC[i%3]+';box-shadow:0 0 8px '+LC[i%3]+'"></span><span class="t-sm fw6">'+l+'</span></div>';
    h+='<div style="display:flex;flex-direction:column;gap:8px">';
    h+='<div class="flex jcsb t-xs"><span class="c50">Restant d√ª</span><span class="fw5">'+fmt(cu)+'</span></div>';
    h+='<div class="flex jcsb t-xs"><span class="c50">Initial</span><span class="c50">'+fmt(ini)+'</span></div>';
    h+='<div class="flex jcsb t-xs"><span class="c50">Rembours√©</span><span class="cg">'+fmt(po)+' ('+pp+'%)</span></div>';
    if(mo>0) h+='<div class="flex jcsb t-xs"><span class="c50">Mensualit√©</span><span class="cy">'+fmt(mo)+'/mois</span></div>';
    h+='<div class="neon-bar mt2"><div class="neon-fill" style="width:'+pp+'%;background:linear-gradient(90deg,#10b981,#059669)"></div></div>';
    h+='</div></div>';
  });
  h+='</div>';

  h+='<div class="card chart-card"><h3 class="t-sm fw6 mb4">√âvolution des emprunts</h3><div class="canvas-wrap"><canvas id="ch-loans"></canvas></div></div>';

  h+='<div class="grid grid-2">';
  h+='<div class="card chart-card"><h3 class="t-sm fw6 mb4">Capital net vs dette</h3><div class="canvas-wrap"><canvas id="ch-netdebt"></canvas></div></div>';
  h+='<div class="card"><h3 class="t-sm fw6 mb4">Indicateurs cl√©s</h3><div style="display:flex;flex-direction:column;gap:16px">';
  h+='<div class="ind-card"><div class="t-xs c50" style="margin-bottom:4px">Taux d\'endettement</div><div class="t-lg fw7">'+(t.tp>0?(t.tl/t.tp*100).toFixed(1):0)+'%</div><div class="t-xs c30">Dette / Capital brut</div></div>';
  h+='<div class="ind-card"><div class="t-xs c50" style="margin-bottom:4px">Couverture remboursements</div><div class="t-lg fw7" style="color:'+(t.lmi>=t.tmp?'#10b981':'#ef4444')+'">'+(t.tmp>0?(t.lmi/t.tmp).toFixed(2)+'x':'N/A')+'</div><div class="t-xs c30">Int√©r√™ts / Mensualit√©s</div></div>';
  h+='<div class="ind-card"><div class="t-xs c50" style="margin-bottom:4px">Rendement net</div><div class="t-lg fw7" style="color:'+(t.nmi>=0?'#10b981':'#ef4444')+'">'+(t.tp>0?(t.nmi*12/t.tp*100).toFixed(1):0)+'% / an</div><div class="t-xs c30">(Int√©r√™ts - Remb.) √ó 12 / Capital</div></div>';
  h+='</div></div>';
  h+='</div></div>';
  return h;
}

function buildLoanCharts(t,labels,li){
  var loanSets=(data.loanNames||[]).map(function(l,i){
    return{label:l,data:data.months.map(function(_,j){return(data.loans[l]||[])[j]||0;}),borderColor:LC[i%3],backgroundColor:hexToRgba(LC[i%3],.1),fill:true,borderWidth:1.5,tension:.3};
  });
  charts.loans=new Chart(document.getElementById('ch-loans'),{type:'line',data:{labels:labels,datasets:loanSets},options:{responsive:true,maintainAspectRatio:false,scales:{x:{ticks:{maxTicksLimit:8}},y:{ticks:{callback:fmtK}}}}});

  var brutD=data.months.map(function(_,i){return data.platforms.reduce(function(s,p){return s+((data.principal[p]||[])[i]||0);},0);});
  var empD=data.months.map(function(_,i){return(data.loanNames||[]).reduce(function(s,l){return s+((data.loans[l]||[])[i]||0);},0);});
  var netD=brutD.map(function(b,i){return b-empD[i];});
  charts.netdebt=new Chart(document.getElementById('ch-netdebt'),{type:'line',data:{labels:labels,datasets:[
    {label:'Capital brut',data:brutD,borderColor:'#8b5cf6',backgroundColor:hexToRgba('#8b5cf6',.06),fill:true,borderWidth:2,tension:.3},
    {label:'Emprunts',data:empD,borderColor:'#ef4444',borderDash:[5,5],backgroundColor:'transparent',borderWidth:1.5,tension:.3},
    {label:'Capital net',data:netD,borderColor:'#10b981',backgroundColor:hexToRgba('#10b981',.06),fill:true,borderWidth:2,tension:.3}
  ]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{ticks:{maxTicksLimit:8}},y:{ticks:{callback:fmtK}}}}});
}

// ========== UPDATE TAB ==========
function renderUpdate(t,li){
  var h='<div class="grid">';
  // Data management
  h+='<div class="card"><div class="flex jcsb aic fw gap4 mob-col">';
  h+='<div><h3 class="t-sm fw6">Gestion des donn√©es</h3><p class="t-xs c40" style="margin-top:4px">Sauvegarde automatique. Export JSON pour transf√©rer vers un autre appareil.</p></div>';
  h+='<div class="flex fw gap2">';
  h+='<button class="btn btn-ok" onclick="exportJSON()">Exporter JSON</button>';
  h+='<button class="btn btn-s" onclick="document.getElementById(\'fileInput\').click()">Importer JSON</button>';
  h+='<input id="fileInput" type="file" accept=".json" onchange="importJSON(event)" class="hidden">';
  h+='<button class="btn btn-p" onclick="toggleAddMonth()">+ Nouveau mois</button>';
  h+='</div></div>';
  if(showAddMonth){
    var nm=nextMonth(data.months[data.months.length-1]);
    h+='<div class="info-box mt4"><div class="flex jcsb aic fw gap2">';
    h+='<div><span class="t-xs fw5">Ajouter : </span><span class="t-xs fw6" style="color:#8b5cf6">'+fmMonth(nm)+'</span><span class="t-xs c40" style="margin-left:8px">(valeurs pr√©c√©dentes copi√©es)</span></div>';
    h+='<div class="flex gap2"><button class="btn btn-s" onclick="toggleAddMonth()">Annuler</button><button class="btn btn-p" onclick="addMonth()">Confirmer</button></div>';
    h+='</div></div>';
  }
  h+='</div>';

  // Monthly update
  h+='<div class="card"><div class="flex jcsb aic fw gap4 mb6 mob-col">';
  h+='<h3 class="t-sm fw6">Mise √† jour mensuelle</h3>';
  h+='<div class="flex aic gap3">';
  h+='<select onchange="changeEditMonth(this.value)">';
  data.months.forEach(function(m,i){h+='<option value="'+i+'"'+(editMonth===i?' selected':'')+'>'+fmMonth(m)+'</option>';});
  h+='</select>';
  if(!editing) h+='<button class="btn btn-p" onclick="startEditing()">Modifier</button>';
  h+='</div></div>';

  if(editing){
    h+='<div><div class="t-xs fw6 c50 mb3">Plateformes d\'investissement</div>';
    h+='<div class="grid-form" style="margin-bottom:24px">';
    data.platforms.forEach(function(p,i){
      var intVal=formData[p]?formData[p].interest:'';
      var prinVal=formData[p]?formData[p].principal:'';
      h+='<div class="form-card">';
      h+='<div class="flex aic gap2 mb3"><span class="dot-s" style="background:'+COLORS[i%10]+';box-shadow:0 0 6px '+COLORS[i%10]+'"></span><span class="t-xs fw5">'+p+'</span></div>';
      h+='<div style="display:flex;flex-direction:column;gap:8px">';
      h+='<div><label class="t-xs c40" style="display:block;margin-bottom:4px">Int√©r√™ts (‚Ç¨)</label><input type="number" value="'+intVal+'" onchange="updateForm(\''+p+'\',\'interest\',this.value)" placeholder="0"></div>';
      h+='<div><label class="t-xs c40" style="display:block;margin-bottom:4px">Capital total (‚Ç¨)</label><input type="number" value="'+prinVal+'" onchange="updateForm(\''+p+'\',\'principal\',this.value)" placeholder="0"></div>';
      h+='</div></div>';
    });
    h+='</div>';

    if((data.loanNames||[]).length>0){
      h+='<div class="t-xs fw6 c50 mb3">Emprunts en cours</div><div class="grid-form" style="margin-bottom:24px">';
      data.loanNames.forEach(function(l,i){
        var lv=loanFormData[l]||'';
        h+='<div class="loan-card"><div class="flex aic gap2 mb3"><span class="dot-s" style="background:'+LC[i%3]+';box-shadow:0 0 6px '+LC[i%3]+'"></span><span class="t-xs fw5">'+l+'</span></div>';
        h+='<label class="t-xs c40" style="display:block;margin-bottom:4px">Restant d√ª (‚Ç¨)</label>';
        h+='<input type="number" class="loan-input" value="'+lv+'" onchange="updateLoanForm(\''+l+'\',this.value)" placeholder="0">';
        h+='</div>';
      });
      h+='</div>';
    }
    h+='<div class="flex gap3" style="justify-content:flex-end"><button class="btn btn-s" onclick="cancelEditing()">Annuler</button><button class="btn btn-ok" onclick="saveMonth()">Sauvegarder</button></div>';
    h+='</div>';
  } else {
    // Read-only table
    h+='<div class="ox"><table><thead><tr><th>Plateforme</th><th class="th-r">Capital</th><th class="th-r">Int√©r√™ts</th><th class="th-r">% total</th></tr></thead><tbody>';
    var tc=data.platforms.reduce(function(s,p){return s+((data.principal[p]||[])[editMonth]||0);},0);
    data.platforms.forEach(function(p,i){
      var c=(data.principal[p]||[])[editMonth]||0;
      var it=(data.interests[p]||[])[editMonth]||0;
      h+='<tr style="border-bottom:1px solid rgba(255,255,255,.03)"><td><div class="flex aic gap2"><span class="dot" style="background:'+COLORS[i%10]+';box-shadow:0 0 4px '+COLORS[i%10]+'"></span>'+p+'</div></td>';
      h+='<td class="td-r">'+fmt(c)+'</td><td class="td-r" style="color:'+(it>0?'#10b981':'rgba(255,255,255,.3)')+'">'+( it>0?'+'+fmt(it):'-')+'</td>';
      h+='<td class="td-r c40">'+(tc>0?(c/tc*100).toFixed(1)+'%':'-')+'</td></tr>';
    });
    var totalInt=data.platforms.reduce(function(s,p){return s+((data.interests[p]||[])[editMonth]||0);},0);
    h+='<tr style="border-top:1px solid rgba(139,92,246,.2)"><td class="fw6">Total</td><td class="td-r fw6">'+fmt(tc)+'</td><td class="td-r fw6 cg">+'+fmt(totalInt)+'</td><td class="td-r fw6">100%</td></tr>';
    h+='</tbody></table>';

    if((data.loanNames||[]).length>0){
      h+='<div class="t-xs fw6 c50 mt4" style="margin-bottom:8px">Emprunts</div><table><tbody>';
      var totalLoans=0;
      data.loanNames.forEach(function(l,i){
        var lv=(data.loans[l]||[])[editMonth]||0;totalLoans+=lv;
        h+='<tr style="border-bottom:1px solid rgba(255,255,255,.03)"><td><div class="flex aic gap2"><span class="dot" style="background:'+LC[i%3]+';box-shadow:0 0 4px '+LC[i%3]+'"></span>'+l+'</div></td><td class="td-r cr">'+fmt(lv)+'</td></tr>';
      });
      h+='<tr style="border-top:1px solid rgba(239,68,68,.15)"><td class="fw6">Total emprunts</td><td class="td-r fw6 cr">'+fmt(totalLoans)+'</td></tr>';
      h+='<tr style="border-top:1px solid rgba(139,92,246,.2)"><td class="fw7">Capital net</td><td class="td-r fw7 cg">'+fmt(tc-totalLoans)+'</td></tr>';
      h+='</tbody></table>';
    }
    h+='</div>';
  }
  h+='</div></div>';
  return h;
}

// ========== ACTIONS ==========
function switchTab(id){currentTab=id;render();}

function exportJSON(){
  var b=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  var u=URL.createObjectURL(b);var a=document.createElement("a");a.href=u;a.download="data-investissement.json";a.click();URL.revokeObjectURL(u);
  notify("JSON export√© !");
}

function importJSON(e){
  var f=e.target.files&&e.target.files[0];if(!f)return;
  var r=new FileReader();
  r.onload=function(ev){
    try{
      var p=JSON.parse(ev.target.result);
      if(!p.platforms||!p.months){notify("Format invalide.","err");return;}
      if(!p.loanNames)p.loanNames=[];if(!p.loans)p.loans={};if(!p.loanMonthlyPayments)p.loanMonthlyPayments={};
      data=p;saveData(data);editMonth=data.months.length-1;editing=false;
      notify("Import√© : "+data.months.length+" mois");render();
    }catch(x){notify("Erreur JSON.","err");}
  };
  r.readAsText(f);e.target.value="";
}

function toggleAddMonth(){showAddMonth=!showAddMonth;render();}

function addMonth(){
  var nm=nextMonth(data.months[data.months.length-1]);
  data.months.push(nm);
  data.platforms.forEach(function(p){
    data.interests[p]=data.interests[p]||[];data.interests[p].push(0);
    data.principal[p]=data.principal[p]||[];data.principal[p].push(data.principal[p][data.principal[p].length-2]||0);
  });
  (data.loanNames||[]).forEach(function(l){
    data.loans[l]=data.loans[l]||[];data.loans[l].push(data.loans[l][data.loans[l].length-2]||0);
  });
  saveData(data);editMonth=data.months.length-1;showAddMonth=false;
  notify(fmMonth(nm)+" ajout√© !");
  startEditing();
}

function changeEditMonth(val){editMonth=parseInt(val);if(editing)loadFormData();render();}

function loadFormData(){
  formData={};
  data.platforms.forEach(function(p){
    formData[p]={interest:(data.interests[p]||[])[editMonth]||0,principal:(data.principal[p]||[])[editMonth]||0};
  });
  loanFormData={};
  (data.loanNames||[]).forEach(function(l){
    loanFormData[l]=(data.loans[l]||[])[editMonth]||0;
  });
}

function startEditing(){editing=true;loadFormData();render();}
function cancelEditing(){editing=false;render();}

function updateForm(platform,field,value){
  if(!formData[platform])formData[platform]={interest:0,principal:0};
  formData[platform][field]=value;
}
function updateLoanForm(loan,value){loanFormData[loan]=value;}

function saveMonth(){
  data.platforms.forEach(function(p){
    if(!data.interests[p])data.interests[p]=[];
    if(!data.principal[p])data.principal[p]=[];
    while(data.interests[p].length<=editMonth)data.interests[p].push(0);
    while(data.principal[p].length<=editMonth)data.principal[p].push(0);
    data.interests[p][editMonth]=Number(formData[p]&&formData[p].interest)||0;
    data.principal[p][editMonth]=Number(formData[p]&&formData[p].principal)||0;
  });
  (data.loanNames||[]).forEach(function(l){
    if(!data.loans[l])data.loans[l]=[];
    while(data.loans[l].length<=editMonth)data.loans[l].push(0);
    data.loans[l][editMonth]=Number(loanFormData[l])||0;
  });
  saveData(data);editing=false;notify("Sauvegard√© !");render();
}

// ========== INIT ==========
render();
</script>
</body>
</html>
